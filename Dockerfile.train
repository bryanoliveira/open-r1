# Build
# docker build --build-arg GIT_COMMIT=$(git rev-parse HEAD) --build-arg WANDB_KEY=<wandb> --build-arg HF_TOKEN=<hf> -f Dockerfile -t aluno_bryan-openr1:latest .
# Run (local)
# sudo docker run --gpus '"device=0"' -v ~/.cache/huggingface:/root/.cache/huggingface -e MODEL=deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B aluno_bryan-openr1:latest
# Run (dgx)
# docker run --gpus '"device=5"' -v /raid/bryan/huggingface:/root/.cache/huggingface -e MODEL=deepseek-ai/DeepSeek-R1-Distill-Qwen-1.5B -e MODEL_ARGS='dtype=float16,max_model_length=32768,gpu_memory_utilisation=0.9' aluno_bryan-openr1:latest

# Use CUDA 12.4 base image
FROM nvidia/cuda:12.4.0-devel-ubuntu22.04

# Set environment variables
ENV DEBIAN_FRONTEND=noninteractive
ENV PYTHONUNBUFFERED=1

# Add build arguments and set environment variables
ARG GIT_COMMIT
ARG WANDB_KEY
ARG HF_TOKEN

ENV GIT_COMMIT=$GIT_COMMIT
ENV WANDB_API_KEY=$WANDB_KEY
ENV HUGGING_FACE_HUB_TOKEN=$HF_TOKEN

# Install system dependencies
RUN apt-get update && apt-get install -y \
    git \
    git-lfs \
    python3.11 \
    python3.11-dev \
    python3-pip \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv
ADD https://astral.sh/uv/install.sh /uv-installer.sh
RUN sh /uv-installer.sh && rm /uv-installer.sh
ENV PATH="/root/.local/bin/:$PATH"

# Create and activate virtual environment
RUN uv venv /opt/venv --python python3.11
ENV PATH="/opt/venv/bin:$PATH"

# Install dependencies
RUN uv pip install --upgrade pip --link-mode=copy && \
    uv pip install vllm==0.7.2 setuptools wheel --link-mode=copy

# Copy dependency files first
WORKDIR /app
COPY pyproject.toml .
COPY setup.py .
COPY setup.cfg .

# Install project dependencies
RUN GIT_LFS_SKIP_SMUDGE=1 uv pip install -e ".[dev]" --link-mode=copy --no-build-isolation

# Copy the rest of the project
COPY . .

# Default environment variables for training
ENV RECIPE="recipes/accelerate_configs/zero2.yaml"
ENV CONFIG="recipes/Qwen2.5-1.5B-Instruct/grpo/config_demo.yaml"
ENV NUM_PROCESSES=7
ENV EXTRA=""

# Entrypoint that launches GRPO training
ENTRYPOINT ["sh", "-c", "ACCELERATE_LOG_LEVEL=info accelerate launch --config_file ${RECIPE} --num_processes=${NUM_PROCESSES} src/open_r1/grpo.py --config ${CONFIG} ${EXTRA}"]